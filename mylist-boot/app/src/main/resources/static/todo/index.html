<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>연락처</title>
    <style>
        .todo-checked {
            text-decoration: line-through;
            color: gray;
        }
    </style>
</head>
<body>
    <h1>To-do</h1>
    <a href="form.html">추가</a>
    <table id="x-todo-table" border="1">
        <thead>
            <tr>
                <th></th>
                <th>해야 할 일</th>
                <th>변경</th>
                <th>삭제</th>
            </tr>
        </thead>
        <tbody>
            
        </tbody>
    </table>

    <input type="text" id="x-title-input">

    <script>
        var titleInput = document.querySelector("#x-title-input")
        // titleInput.style["display"] = "none"

        var tbody = document.querySelector("#x-todo-table tbody")
        
        fetch("/todo/list")
        .then(function(response) {
            return response.json()
        })
        .then(function(todoList) {
            console.log(todoList)
            for (var i = 0; i < todoList.length; i++) {
                var tr = document.createElement("tr")
                var checkedOption = ""
                var titleTdOption = ""
                if (todoList[i].done) {
                    checkedOption = "checked"
                    titleTdOption = "class='todo-checked'"
                }
                tr.innerHTML = `<td><input type="checkbox" ${checkedOption} onchange="checkTodo(${i},event.target.checked)"></td>
                <td data-no="${i}" ${titleTdOption}><span>${todoList[i].title}</span></td>                
                <td><button type="button" class="update-btn" data-no="${i}">변경</td>
                <td><button type="button" class="delet-btn" data-no="${i}">삭제</td>`

                tbody.appendChild(tr)
            }
        })

        tbody.onclick = function(e) {
            // 삭제 버튼을 클릭 했을 때 호출될 리스너 등록하기
            // => 삭제 버튼은 동적으로 생성된다.
            // => 따라서 부모 태그에 리스너를 등록해야 한다.
            // if (e.target instanceof HTMLButtonElement) {  or
             if (e.target.classList == "delet-btn") {
                var no = e.target.getAttribute("data-no")
                fetch(`/todo/delete?index=${no}`)
                .then(function(response){
                    return response.json()
                })
                .then(function(result) {
                   if (result == 0) {
                       window.alert("삭제할 수 없습니다.")
                   } else {
                    location.reload()
                   }
                })
            }
            if (e.target.classList == "update-btn") {
                var no = e.target.getAttribute("data-no")
                // 현재 todo 항목을 편집 중인 상태에서 변경 버튼을 눌렀다면
                if (titleInput.parentNode instanceof HTMLTableCellElement){
                    // 다른 항목을 편집하기 위해 이동하기 전 해당항목을 편집 전의 상태로 되돌린다.
                    titleInput.parentNode.querySelector("span").style["display"] = ""
                }
                var titleTd = document.querySelector(`tbody td[data-no="${no}"]`)
                var titleSpan = titleTd.querySelector("span")
                titleSpan.style["display"] = "none"
                titleInput.value = titleSpan.innerHTML
                titleTd.appendChild(titleInput)
            }
        }

        titleInput.onkeyup = function(e) {
            var no = titleInput.parentNode.getAttribute("data-no")
            var originTitle = titleInput.parentNode.querySelector("span").innerHTML
            if (e.keyCode == 13 && titleInput.value != "" && originTitle != titleInput.value) {
                fetch(`/todo/update?index=${no}&title=${titleInput.value}`)
                .then(function(response){
                    return response.json()
                })
                .then(function(result) {
                   if (result == 0) {
                       window.alert("변경하지 못했습니다!")
                   } else {
                    titleInput.parentNode.querySelector("span").innerHTML = titleInput.value
                    titleInput.parentNode.querySelector("span").style["display"] = ""
                    titleInput.style["display"] = "none"
                    document.body.appendChild(titleInput)
                   }
                })
            }
        }


        function checkTodo(no, checked) {
            fetch(`/todo/check?index=${no}&done=${checked}`)
            .then(function(response){
                return response.json()
            })
            .then(function(result) {
                if (result == 0) {
                    window.alert("변경하지 못했습니다!");
                } else {
                     var titleTd = document.querySelector(`tbody td[data-no="${no}"]`)
                    if (checked) {
                        titleTd.classList.add("todo-checked")
                    } else {
                    titleTd.classList.remove("todo-checked")
                    }
                }
            })
        }
    </script>
</body>
</html>